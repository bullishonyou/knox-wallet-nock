{% extends "base.html" %}

{% block title %}Send Transaction - KNOX{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Send Transaction</h1>
    
    <div class="form-card">
        <!-- Active Wallet Balance Card -->
        <div class="balance-card">
            <div class="balance-header">
                <h3>Your Balance</h3>
                <span class="balance-status" id="balance-status">Loading...</span>
            </div>
            <div class="balance-display">
                <div class="balance-amount" id="balance-amount">0</div>
                <div class="balance-unit">NOCK</div>
            </div>
        </div>
        
        <form id="send-form">
            <div class="form-group">
                <label for="sender">From Address:</label>
                <div class="from-address-display">
                    <code id="sender-display">Loading active address...</code>
                    <input type="hidden" id="sender" required>
                </div>
                <small class="form-hint">Using your active wallet address</small>
            </div>
            
            <div class="form-group">
                <label for="recipient">To Address:</label>
                <input type="text" id="recipient" class="form-control" placeholder="Recipient's public address" required>
            </div>
            
            <div class="form-group">
                <label for="amount">Amount (NOCK):</label>
                <input type="number" id="amount" class="form-control" placeholder="0.00000000" step="0.00000001" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="fee">Fee (NOCK):</label>
                <input type="number" id="fee" class="form-control" placeholder="0.00001" step="0.00000001" min="0" value="0.00001" required>
            </div>
            
            <div class="summary-box">
                <h3>Transaction Summary</h3>
                <div class="summary-item">
                    <span>Amount:</span>
                    <span id="summary-amount">0 NOCK</span>
                </div>
                <div class="summary-item">
                    <span>Fee:</span>
                    <span id="summary-fee">0 NOCK</span>
                </div>
                <div class="summary-item total">
                    <span>Total:</span>
                    <span id="summary-total">0 NOCK</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-large" id="submit-btn">Send Transaction</button>
        </form>
        
        <div id="success-alert" class="alert alert-success hidden">
            ✓ Transaction sent successfully!
            <div id="tx-result" class="tx-result"></div>
        </div>
        
        <div id="error-alert" class="alert alert-error hidden">
            <strong>Error:</strong> <span id="error-text"></span>
        </div>

        <div id="loading-spinner" class="hidden">
            <div class="spinner"></div>
            <p>Processing transaction...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const sendForm = document.getElementById('send-form');
    const senderInput = document.getElementById('sender');
    const senderDisplay = document.getElementById('sender-display');
    const recipientInput = document.getElementById('recipient');
    const amountInput = document.getElementById('amount');
    const feeInput = document.getElementById('fee');
    const summaryAmount = document.getElementById('summary-amount');
    const summaryFee = document.getElementById('summary-fee');
    const summaryTotal = document.getElementById('summary-total');
    const successAlert = document.getElementById('success-alert');
    const errorAlert = document.getElementById('error-alert');
    const errorText = document.getElementById('error-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const txResult = document.getElementById('tx-result');
    const submitBtn = document.getElementById('submit-btn');
    const balanceAmount = document.getElementById('balance-amount');
    const balanceStatus = document.getElementById('balance-status');

    // Check localStorage for cached active wallet first
    function getCachedActiveWallet() {
        const cachedAddress = localStorage.getItem('activeAddress');
        const cachedVersion = localStorage.getItem('activeVersion');
        const cachedBalance = localStorage.getItem('activeBalance');
        
        if (cachedAddress) {
            return {
                address: cachedAddress,
                version: cachedVersion || '1',
                balance_nock: cachedBalance || '0'
            };
        }
        return null;
    }

    // Load active address from localStorage on page load
    function loadActiveAddress() {
        const cachedAddress = localStorage.getItem('activeAddress');
        
        if (cachedAddress) {
            senderInput.value = cachedAddress;
            // Display truncated version for readability
            const displayText = cachedAddress.substring(0, 20) + '...' + cachedAddress.substring(cachedAddress.length - 20);
            senderDisplay.textContent = displayText;
            senderDisplay.title = cachedAddress; // Full address on hover
        } else {
            // Fetch from API if not in cache
            fetchActiveAddress();
        }
    }

    // Fetch active address from API
    async function fetchActiveAddress() {
        try {
            const response = await fetch('/api/active-wallet');
            const data = await response.json();
            
            if (data.success && data.address) {
                const address = data.address;
                senderInput.value = address;
                // Cache it for future use
                localStorage.setItem('activeAddress', address);
                
                const displayText = address.substring(0, 20) + '...' + address.substring(address.length - 20);
                senderDisplay.textContent = displayText;
                senderDisplay.title = address;
                
                submitBtn.disabled = false;
            } else {
                showError('No active wallet found. Please set an active wallet first.');
                submitBtn.disabled = true;
            }
        } catch (error) {
            showError('Failed to load active address: ' + error.message);
            submitBtn.disabled = true;
        }
    }

    // Display balance
    function displayBalance(balance) {
        const balanceValue = parseFloat(balance || 0).toFixed(8);
        balanceAmount.textContent = balanceValue;
        balanceStatus.textContent = '✓ Up to date';
    }

    // Load balance for active address
    async function loadBalance() {
        try {
            // First, try to use cached data from localStorage
            const cached = getCachedActiveWallet();
            if (cached && cached.address) {
                // Display cached balance immediately
                displayBalance(cached.balance_nock);
                
                // In background, fetch fresh data to update cache
                try {
                    const response = await fetch('/api/active-wallet');
                    const data = await response.json();
                    if (data.success && data.balance_nock !== undefined) {
                        // Update cache with fresh balance
                        localStorage.setItem('activeBalance', data.balance_nock);
                        // Update UI with fresh balance
                        displayBalance(data.balance_nock);
                    }
                } catch (error) {
                    console.error('Background refresh failed (using cache):', error);
                    // Keep showing cached balance
                }
            } else {
                // No cache, fetch from API
                const response = await fetch('/api/active-wallet');
                const data = await response.json();
                
                if (data.success && data.address) {
                    // Cache the response
                    localStorage.setItem('activeBalance', data.balance_nock || 0);
                    displayBalance(data.balance_nock);
                } else {
                    balanceAmount.textContent = '0';
                    balanceStatus.textContent = '⚠ Unable to fetch';
                }
            }
        } catch (error) {
            console.error('Error loading balance:', error);
            balanceAmount.textContent = '0';
            balanceStatus.textContent = '❌ Error';
        }
    }

    // Update summary on input change
    amountInput.addEventListener('input', updateSummary);
    feeInput.addEventListener('input', updateSummary);

    function updateSummary() {
        const amount = parseFloat(amountInput.value) || 0;
        const fee = parseFloat(feeInput.value) || 0;
        const total = amount + fee;

        summaryAmount.textContent = amount.toFixed(8) + ' NOCK';
        summaryFee.textContent = fee.toFixed(8) + ' NOCK';
        summaryTotal.textContent = total.toFixed(8) + ' NOCK';
    }

    sendForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        successAlert.classList.add('hidden');
        errorAlert.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        const sender = senderInput.value;
        const recipient = recipientInput.value;
        const amount = parseFloat(amountInput.value);
        const fee = parseFloat(feeInput.value);

        if (!sender || !recipient || amount <= 0 || fee < 0) {
            showError('Please fill in all fields correctly');
            loadingSpinner.classList.add('hidden');
            return;
        }

        if (recipient.length < 10) {
            showError('Invalid recipient address');
            loadingSpinner.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch('/api/send-transaction', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender: sender,
                    recipient: recipient,
                    amount: amount,
                    fee: fee
                })
            });

            const data = await response.json();

            if (data.success) {
                txResult.innerHTML = '<pre>' + JSON.stringify(data.data, null, 2) + '</pre>';
                successAlert.classList.remove('hidden');
                sendForm.reset();
                // Reload active address and balance
                loadActiveAddress();
                loadBalance();
                updateSummary();
            } else {
                showError(data.error || 'Failed to send transaction');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    });

    function showError(message) {
        errorText.textContent = message;
        errorAlert.classList.remove('hidden');
    }

    // Load active address and balance on page load
    loadActiveAddress();
    loadBalance();
    
    // Initialize summary
    updateSummary();
</script>
{% endblock %}
