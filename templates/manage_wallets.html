{% extends "base.html" %}

{% block title %}Manage Wallets - KNOX{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Manage Wallets</h1>
    
    <div class="form-card">
        <div id="wallets-list" class="wallets-table">
            <div class="loading">Loading wallets...</div>
        </div>
        
        <div id="error-alert" class="alert alert-error hidden">
            <strong>Error:</strong> <span id="error-text"></span>
        </div>

        <div id="success-alert" class="alert alert-success hidden">
            <strong>Success:</strong> <span id="success-text"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadWallets() {
        try {
            const response = await fetch('/api/wallets');
            const data = await response.json();
            
            if (data.success) {
                const walletsList = document.getElementById('wallets-list');
                const wallets = data.wallets || [];
                const activeAddress = data.active_address;
                
                if (wallets.length === 0) {
                    walletsList.innerHTML = '<p class="empty-state">No wallets found</p>';
                    return;
                }
                
                let html = `
                    <table class="wallets-table-actual">
                        <thead>
                            <tr>
                                <th style="width: 60%;">Address</th>
                                <th style="width: 15%;">Version</th>
                                <th style="width: 25%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const wallet of wallets) {
                    // Skip wallets with empty addresses
                    if (!wallet.address || wallet.address.trim() === '') {
                        continue;
                    }
                    
                    const isActive = wallet.is_active || wallet.address === activeAddress;
                    const truncatedAddress = wallet.address.substring(0, 20) + '...' + wallet.address.substring(wallet.address.length - 20);
                    
                    let actionHtml;
                    if (isActive) {
                        actionHtml = '<span class="badge badge-active">üü¢ Active</span>';
                    } else {
                        actionHtml = `
                            <button class="btn btn-sm btn-secondary" onclick="setActiveWallet(event, '${wallet.address}', '${wallet.version}')" title="Set as active wallet">
                                ‚ö´Ô∏è Set Active
                            </button>
                        `;
                    }
                    
                    html += `
                        <tr>
                            <td class="address-cell" onclick="copyToClipboard('${wallet.address}')" title="Click to copy: ${wallet.address}" style="cursor: pointer;">
                                <code style="word-break: break-all;">${truncatedAddress}</code>
                                <span class="copy-hint">üìã click to copy</span>
                            </td>
                            <td class="version-cell" style="text-align: center;">
                                <span class="badge" style="background-color: #4CAF50; color: white; padding: 0.4rem 0.8rem; border-radius: 4px;">v${wallet.version}</span>
                            </td>
                            <td class="status-cell" style="text-align: center;">
                                ${actionHtml}
                            </td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table>';
                walletsList.innerHTML = html;
            } else {
                showError(data.error || 'Failed to load wallets');
            }
        } catch (error) {
            showError(error.message);
        }
    }
    
    async function setActiveWallet(event, address, version) {
        event.preventDefault();
        try {
            hideAlerts();
            
            // Cache immediately to localStorage for faster display
            localStorage.setItem('activeAddress', address);
            localStorage.setItem('activeVersion', version);
            localStorage.setItem('activeBalance', '0'); // Reset balance, will be fetched on dashboard
            
            // Show success message
            showSuccess(`Setting ${address.substring(0, 10)}... as active...`);
            
            // Call the API in the background
            const response = await fetch('/api/set-active-wallet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ address: address })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Redirect immediately to dashboard (don't wait for response)
                setTimeout(() => window.location.href = '/', 800);
            } else {
                showError(data.error || 'Failed to set active wallet');
                // Clear cache on error
                localStorage.removeItem('activeAddress');
                localStorage.removeItem('activeVersion');
            }
        } catch (error) {
            showError(error.message);
            // Clear cache on error
            localStorage.removeItem('activeAddress');
            localStorage.removeItem('activeVersion');
        }
    }
    
    function copyToClipboard(address) {
        navigator.clipboard.writeText(address).then(() => {
            // Visual feedback
            showSuccess('‚úì Address copied to clipboard!');
            setTimeout(() => hideAlerts(), 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            showError('Failed to copy address');
        });
    }
    
    function showError(message) {
        document.getElementById('error-text').textContent = message;
        document.getElementById('error-alert').classList.remove('hidden');
    }

    function showSuccess(message) {
        document.getElementById('success-text').textContent = message;
        document.getElementById('success-alert').classList.remove('hidden');
    }

    function hideAlerts() {
        document.getElementById('error-alert').classList.add('hidden');
        document.getElementById('success-alert').classList.add('hidden');
    }
    
    // Load wallets on page load
    loadWallets();
</script>
{% endblock %}
