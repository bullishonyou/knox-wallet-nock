{% extends "base.html" %}

{% block title %}Balance - KNOX{% endblock %}

{% block content %}
<div class="form-container">
    <h1>Check Balance</h1>
    
    <div class="form-card">
        <div class="form-group">
            <label for="address-select">Select Address:</label>
            <select id="address-select" class="form-control" required>
                <option value="">-- Loading wallets... --</option>
            </select>
            <span id="version-info" class="form-text"></span>
        </div>
        
        <button id="check-btn" class="btn btn-primary" style="width: 100%;">üîç Check Balance</button>
    </div>

    <div id="balance-container" class="hidden">
        <div class="balance-card">
            <div class="balance-display">
                <div class="balance-amount">
                    <span id="balance-value">--</span>
                    <span class="balance-unit">NOCK</span>
                </div>
                <div class="balance-label">Total Balance</div>
            </div>
        </div>

        <div class="transactions-card">
            <h2>Transaction History</h2>
            <div id="transactions-list" class="transactions-table">
                <!-- Transactions will be loaded here -->
            </div>
        </div>
    </div>

    <div id="error-alert" class="alert alert-error hidden">
        <strong>Error:</strong> <span id="error-text"></span>
    </div>

    <div id="warning-alert" class="alert alert-warning hidden">
        <strong>‚ÑπÔ∏è Notice:</strong> <span id="warning-text"></span>
    </div>

    <div id="loading-spinner" class="hidden">
        <div class="spinner"></div>
        <p>Loading balance...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const addressSelect = document.getElementById('address-select');
    const versionInfo = document.getElementById('version-info');
    const checkBtn = document.getElementById('check-btn');
    const balanceContainer = document.getElementById('balance-container');
    const balanceValue = document.getElementById('balance-value');
    const transactionsList = document.getElementById('transactions-list');
    const errorAlert = document.getElementById('error-alert');
    const errorText = document.getElementById('error-text');
    const warningAlert = document.getElementById('warning-alert');
    const warningText = document.getElementById('warning-text');
    const loadingSpinner = document.getElementById('loading-spinner');

    let walletAddresses = {}; // Store {address: {version, isActive}}

    // Load wallets on page load
    async function loadWallets() {
        try {
            const response = await fetch('/api/wallets');
            const data = await response.json();

            if (data.success) {
                const wallets = data.wallets || [];
                walletAddresses = {};

                // Build options list
                let options = '<option value="">-- Select an address --</option>';
                for (const wallet of wallets) {
                    walletAddresses[wallet.address] = {
                        version: wallet.version,
                        isActive: wallet.is_active
                    };

                    const marker = wallet.is_active ? ' (active)' : '';
                    const truncated = wallet.address.substring(0, 30) + '...';
                    options += `<option value="${wallet.address}">v${wallet.version}: ${truncated}${marker}</option>`;
                }

                addressSelect.innerHTML = options;

                // Auto-select first wallet
                if (wallets.length > 0) {
                    addressSelect.selectedIndex = 1;
                    updateVersionInfo();
                }
            } else {
                showError(data.error || 'Failed to load wallets');
            }
        } catch (error) {
            showError(error.message);
        }
    }

    // Update version info when selection changes
    addressSelect.addEventListener('change', updateVersionInfo);

    function updateVersionInfo() {
        const address = addressSelect.value;
        const walletInfo = walletAddresses[address];

        if (!walletInfo) {
            versionInfo.innerHTML = '';
            checkBtn.disabled = true;
            return;
        }

        const version = walletInfo.version;
        const isActive = walletInfo.isActive ? ' (active)' : '';

        if (version === '1') {
            versionInfo.innerHTML = `<span style="color: #f59e0b;">‚ö†Ô∏è v1 address - Balance cannot be queried (only v0 addresses support balance queries)</span>`;
            checkBtn.disabled = true;
            checkBtn.style.opacity = '0.5';
        } else {
            versionInfo.innerHTML = `<span style="color: #10b981;">‚úì v0 address${isActive} - Balance can be queried</span>`;
            checkBtn.disabled = false;
            checkBtn.style.opacity = '1';
        }
    }

    checkBtn.addEventListener('click', async () => {
        const address = addressSelect.value;
        
        if (!address) {
            showError('Please select an address');
            return;
        }

        const walletInfo = walletAddresses[address];
        if (walletInfo.version === '1') {
            showWarning('Balance queries only work for v0 addresses. Please select a v0 address.');
            return;
        }

        balanceContainer.classList.add('hidden');
        errorAlert.classList.add('hidden');
        warningAlert.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        checkBtn.disabled = true;

        try {
            const response = await fetch(`/api/balance/${address}`);
            const data = await response.json();

            if (data.success) {
                balanceValue.textContent = parseFloat(data.total_balance_nock).toFixed(8);
                renderTransactions(data.transactions);
                balanceContainer.classList.remove('hidden');
            } else {
                showError(data.error || 'Failed to fetch balance');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            loadingSpinner.classList.add('hidden');
            checkBtn.disabled = false;
        }
    });

    function renderTransactions(transactions) {
        if (transactions.length === 0) {
            transactionsList.innerHTML = '<p class="empty-state">No transactions found</p>';
            return;
        }

        let html = '<table class="tx-table"><thead><tr><th>Amount (NOCK)</th><th>Block</th></tr></thead><tbody>';
        
        for (const tx of transactions) {
            html += `
                <tr>
                    <td class="amount">${parseFloat(tx.amount_nock).toFixed(8)}</td>
                    <td class="details">${tx.block_height || '-'}</td>
                </tr>
            `;
        }
        
        html += '</tbody></table>';
        transactionsList.innerHTML = html;
    }

    function showError(message) {
        errorText.textContent = message;
        errorAlert.classList.remove('hidden');
    }

    function showWarning(message) {
        warningText.textContent = message;
        warningAlert.classList.remove('hidden');
    }

    // Load wallets when page loads
    loadWallets();
</script>
{% endblock %}
