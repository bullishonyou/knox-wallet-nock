{% extends "base.html" %}

{% block title %}Dashboard - KNOX Wallet{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>KNOX Wallet</h1>
    
    <div class="active-wallet-card">
        <h2>Active Wallet</h2>
        <div id="active-wallet-info">
            <div class="loading">Loading wallet info...</div>
        </div>
        <div style="margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="refreshBalance()" style="width: 100%;">
                üîÑ Refresh Balance
            </button>
        </div>
    </div>

    <div class="actions-grid">
        <a href="/create-wallet" class="action-card">
            <div class="action-icon">‚ûï</div>
            <div class="action-title">Create Wallet</div>
            <div class="action-desc">Generate new wallet</div>
        </a>
        
        <a href="/import-wallet" class="action-card">
            <div class="action-icon">üì•</div>
            <div class="action-title">Import Wallet</div>
            <div class="action-desc">Import existing wallet</div>
        </a>
        
        <a href="/manage-wallets" class="action-card">
            <div class="action-icon">üíº</div>
            <div class="action-title">Manage Wallets</div>
            <div class="action-desc">View all wallets</div>
        </a>
        
        <a href="/send" class="action-card">
            <div class="action-icon">üì§</div>
            <div class="action-title">Send Transaction</div>
            <div class="action-desc">Send NOCK</div>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadActiveWallet() {
        try {
            const response = await fetch('/api/active-wallet');
            const data = await response.json();
            
            if (data.success) {
                const infoDiv = document.getElementById('active-wallet-info');
                const balanceDisplay = parseFloat(data.balance_nock).toFixed(8);
                let warningHtml = '';
                
                if (data.warning) {
                    warningHtml = `<div class="alert alert-warning" style="margin-top: 1rem;">
                        ‚ÑπÔ∏è ${data.warning}
                    </div>`;
                }
                
                infoDiv.innerHTML = `
                    <div class="wallet-info">
                        <div class="info-row">
                            <span class="label">Address:</span>
                            <code class="address">${data.address}</code>
                        </div>
                        <div class="info-row">
                            <span class="label">Balance:</span>
                            <span class="balance">${balanceDisplay} NOCK</span>
                        </div>
                    </div>
                    ${warningHtml}
                `;
            } else {
                document.getElementById('active-wallet-info').innerHTML = `
                    <div class="alert alert-warning">
                        No active wallet. Create or import one to get started!
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('active-wallet-info').innerHTML = `
                <div class="alert alert-error">
                    Error loading wallet: ${error.message}
                </div>
            `;
        }
    }
    
    async function refreshBalance() {
        try {
            const refreshBtn = event.target;
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Fetching balance...';
            
            const response = await fetch('/api/refresh-balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                loadActiveWallet(); // Reload the wallet display
                refreshBtn.textContent = '‚úì Balance updated!';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            } else {
                refreshBtn.textContent = '‚ùå Failed to refresh';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            }
        } catch (error) {
            const refreshBtn = event.target;
            refreshBtn.textContent = '‚ùå Error';
            console.error('Error refreshing balance:', error);
            setTimeout(() => {
                refreshBtn.textContent = 'üîÑ Refresh Balance';
                refreshBtn.disabled = false;
            }, 2000);
        }
    }
    
    loadActiveWallet();
    // Refresh every 10 seconds
    setInterval(loadActiveWallet, 10000);
</script>
{% endblock %}
