{% extends "base.html" %}

{% block title %}Dashboard - KNOX Wallet{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>KNOX Wallet</h1>
    
    <div class="active-wallet-card">
        <h2>Active Wallet</h2>
        <div id="active-wallet-info">
            <div class="loading">Loading wallet info...</div>
        </div>
        <div style="margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="refreshBalance()" style="width: 100%;">
                🔄 Refresh Balance
            </button>
        </div>
    </div>

    <div class="actions-grid">
        <a href="/create-wallet" class="action-card">
            <div class="action-icon">➕</div>
            <div class="action-title">Create Wallet</div>
            <div class="action-desc">Generate new wallet</div>
        </a>
        
        <a href="/import-wallet" class="action-card">
            <div class="action-icon">📥</div>
            <div class="action-title">Import Wallet</div>
            <div class="action-desc">Import existing wallet</div>
        </a>
        
        <a href="/manage-wallets" class="action-card">
            <div class="action-icon">💼</div>
            <div class="action-title">Manage Wallets</div>
            <div class="action-desc">View all wallets</div>
        </a>
        
        <a href="/transactions" class="action-card">
            <div class="action-icon">📋</div>
            <div class="action-title">Transactions</div>
            <div class="action-desc">View all transactions</div>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Display wallet info from data object
    function displayWalletInfo(data) {
        const infoDiv = document.getElementById('active-wallet-info');
        const balanceDisplay = parseFloat(data.balance_nock || 0).toFixed(8);
        const blockHeight = data.block_height || 'N/A';
        
        infoDiv.innerHTML = `
            <div class="wallet-info">
                <div class="info-row">
                    <span class="label">Address:</span>
                    <code class="address">${data.address}</code>
                </div>
                <div class="info-row">
                    <span class="label">Balance:</span>
                    <span class="balance">${balanceDisplay} NOCK</span>
                </div>
                <div class="info-row">
                    <span class="label">Block Height:</span>
                    <span>${blockHeight}</span>
                </div>
            </div>
        `;
    }
    
    async function loadActiveWallet() {
        try {
            const response = await fetch('/api/active-wallet');
            const data = await response.json();
            
            if (data.success) {
                displayWalletInfo(data);
            } else {
                document.getElementById('active-wallet-info').innerHTML = `
                    <div class="alert alert-warning">
                        No active wallet. Create or import one to get started!
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('active-wallet-info').innerHTML = `
                <div class="alert alert-error">
                    Error loading wallet: ${error.message}
                </div>
            `;
        }
    }
    
    async function refreshBalance() {
        try {
            const refreshBtn = event.target;
            refreshBtn.disabled = true;
            refreshBtn.textContent = '⏳ Fetching balance...';
            
            const response = await fetch('/api/refresh-balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                loadActiveWallet();
                refreshBtn.textContent = '✓ Balance updated!';
                setTimeout(() => {
                    refreshBtn.textContent = '🔄 Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            } else {
                refreshBtn.textContent = '❌ Failed to refresh';
                setTimeout(() => {
                    refreshBtn.textContent = '🔄 Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            }
        } catch (error) {
            const refreshBtn = event.target;
            refreshBtn.textContent = '❌ Error';
            console.error('Error refreshing balance:', error);
            setTimeout(() => {
                refreshBtn.textContent = '🔄 Refresh Balance';
                refreshBtn.disabled = false;
            }, 2000);
        }
    }
    
    // Load wallet on page load
    loadActiveWallet();
</script>
{% endblock %}
