{% extends "base.html" %}

{% block title %}Dashboard - KNOX Wallet{% endblock %}

{% block content %}
<div class="dashboard">
    <h1>KNOX Wallet</h1>
    
    <div class="active-wallet-card">
        <h2>Active Wallet</h2>
        <div id="active-wallet-info">
            <div class="loading">Loading wallet info...</div>
        </div>
        <div style="margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="refreshBalance()" style="width: 100%;">
                üîÑ Refresh Balance
            </button>
        </div>
    </div>

    <div class="actions-grid">
        <a href="/create-wallet" class="action-card">
            <div class="action-icon">‚ûï</div>
            <div class="action-title">Create Wallet</div>
            <div class="action-desc">Generate new wallet</div>
        </a>
        
        <a href="/import-wallet" class="action-card">
            <div class="action-icon">üì•</div>
            <div class="action-title">Import Wallet</div>
            <div class="action-desc">Import existing wallet</div>
        </a>
        
        <a href="/manage-wallets" class="action-card">
            <div class="action-icon">üíº</div>
            <div class="action-title">Manage Wallets</div>
            <div class="action-desc">View all wallets</div>
        </a>
        
        <a href="/send" class="action-card">
            <div class="action-icon">üì§</div>
            <div class="action-title">Send Transaction</div>
            <div class="action-desc">Send NOCK</div>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Check localStorage for cached active wallet first
    function getCachedActiveWallet() {
        const cachedAddress = localStorage.getItem('activeAddress');
        const cachedVersion = localStorage.getItem('activeVersion');
        const cachedBalance = localStorage.getItem('activeBalance');
        
        if (cachedAddress) {
            return {
                address: cachedAddress,
                version: cachedVersion || '1',
                balance_nock: cachedBalance || '0'
            };
        }
        return null;
    }
    
    // Display wallet info from data object
    function displayWalletInfo(data) {
        const infoDiv = document.getElementById('active-wallet-info');
        const balanceDisplay = parseFloat(data.balance_nock || 0).toFixed(8);
        let warningHtml = '';
        
        if (data.warning) {
            warningHtml = `<div class="alert alert-warning" style="margin-top: 1rem;">
                ‚ÑπÔ∏è ${data.warning}
            </div>`;
        }
        
        infoDiv.innerHTML = `
            <div class="wallet-info">
                <div class="info-row">
                    <span class="label">Address:</span>
                    <code class="address">${data.address}</code>
                </div>
                <div class="info-row">
                    <span class="label">Balance:</span>
                    <span class="balance">${balanceDisplay} NOCK</span>
                </div>
            </div>
            ${warningHtml}
        `;
    }
    
    async function loadActiveWallet() {
        try {
            // First, try to use cached data from localStorage
            const cached = getCachedActiveWallet();
            if (cached && cached.address) {
                // Display cached data immediately
                displayWalletInfo(cached);
                
                // In background, fetch fresh data to update cache
                try {
                    const response = await fetch('/api/active-wallet');
                    const data = await response.json();
                    if (data.success) {
                        // Update cache with fresh data
                        localStorage.setItem('activeAddress', data.address);
                        if (data.balance_nock !== undefined) {
                            localStorage.setItem('activeBalance', data.balance_nock);
                        }
                        // Update UI with fresh data
                        displayWalletInfo(data);
                    }
                } catch (error) {
                    console.error('Background refresh failed (using cache):', error);
                    // Keep showing cached data
                }
            } else {
                // No cache, fetch from API
                const response = await fetch('/api/active-wallet');
                const data = await response.json();
                
                if (data.success) {
                    // Cache the response
                    localStorage.setItem('activeAddress', data.address);
                    localStorage.setItem('activeBalance', data.balance_nock || 0);
                    
                    displayWalletInfo(data);
                } else {
                    document.getElementById('active-wallet-info').innerHTML = `
                        <div class="alert alert-warning">
                            No active wallet. Create or import one to get started!
                        </div>
                    `;
                }
            }
        } catch (error) {
            document.getElementById('active-wallet-info').innerHTML = `
                <div class="alert alert-error">
                    Error loading wallet: ${error.message}
                </div>
            `;
        }
    }
    
    async function refreshBalance() {
        try {
            const refreshBtn = event.target;
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Fetching balance...';
            
            const response = await fetch('/api/refresh-balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update localStorage with fresh balance
                if (data.balance_nock !== undefined) {
                    localStorage.setItem('activeBalance', data.balance_nock);
                }
                
                loadActiveWallet(); // Reload the wallet display
                refreshBtn.textContent = '‚úì Balance updated!';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            } else {
                refreshBtn.textContent = '‚ùå Failed to refresh';
                setTimeout(() => {
                    refreshBtn.textContent = 'üîÑ Refresh Balance';
                    refreshBtn.disabled = false;
                }, 2000);
            }
        } catch (error) {
            const refreshBtn = event.target;
            refreshBtn.textContent = '‚ùå Error';
            console.error('Error refreshing balance:', error);
            setTimeout(() => {
                refreshBtn.textContent = 'üîÑ Refresh Balance';
                refreshBtn.disabled = false;
            }, 2000);
        }
    }
    
    // Load wallet on page load
    loadActiveWallet();
    
    // Note: Removed auto-refresh interval for better performance
    // Users can manually click "Refresh Balance" when needed
</script>
{% endblock %}
